<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易 Markdown 编辑器</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        .container {
            display: flex;
            flex-grow: 1;
        }
        textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-right: none;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            height: 100%;
            outline: none;
            /* Ensure textarea takes full height available */
            resize: none; /* Optional: disable manual resizing */
        }
        #preview {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            background-color: #f9f9f9;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            height: 100%; /* Ensure preview takes full height */
        }
        #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        #preview h1 { font-size: 2em; }
        #preview h2 { font-size: 1.5em; }
        #preview h3 { font-size: 1.17em; }
        #preview p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        #preview code {
            font-family: monospace;
            background-color: #eee;
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }
        #preview pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-family: monospace;
        }
        #preview blockquote {
            border-left: 5px solid #ccc;
            padding-left: 10px;
            margin-left: 0;
        }
        button {
            padding: 8px 15px;
            margin: 10px;
            cursor: pointer;
        }
        /* Ensure container and its children fill the height */
        .container {
             height: calc(100% - 50px); /* Adjust 50px based on button height/margins */
        }
    </style>
</head>
<body>
    <button id="downloadButton">下载 Markdown 文件</button>
    <div class="container">
        <textarea id="markdownInput" placeholder="在此输入 Markdown"></textarea>
        <div id="preview"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        const markdownInput = document.getElementById('markdownInput');
        const preview = document.getElementById('preview');
        const downloadButton = document.getElementById('downloadButton');
        const history = [];
        let historyIndex = -1;
        const maxHistorySize = 50;

        // Helper function to insert text at the current cursor position
        function insertTextAtCursor(text) {
            const start = markdownInput.selectionStart;
            const end = markdownInput.selectionEnd;
            const currentText = markdownInput.value;
            markdownInput.value = currentText.substring(0, start) + text + currentText.substring(end);
            // Place cursor after the inserted text
            markdownInput.selectionStart = markdownInput.selectionEnd = start + text.length;
            // Focus the textarea after insertion
            markdownInput.focus();
        }

        // Function to update the preview pane
        function updatePreview() {
            const markdownText = markdownInput.value;
            // Use marked library to parse Markdown to HTML
            // Added options for better compatibility (e.g., line breaks)
            const html = marked.parse(markdownText, { breaks: true, gfm: true });
            preview.innerHTML = html;
        }

        // Event listener for input changes (typing, pasting handled manually)
        markdownInput.addEventListener('input', function() {
            // Simple history management (could be improved)
            if (history[historyIndex] !== markdownInput.value) {
                historyIndex++;
                if (historyIndex < history.length) {
                    history.length = historyIndex; // Clear redo history
                }
                history.push(markdownInput.value);
                if (history.length > maxHistorySize) {
                    history.shift(); // Remove oldest entry
                    historyIndex--;
                }
            }
            updatePreview();
        });

        // Event listener for keyboard shortcuts (Undo/Redo)
        markdownInput.addEventListener('keydown', function(event) {
            const isUndo = (event.ctrlKey || event.metaKey) && event.key === 'z';
            const isRedo = (event.ctrlKey && event.key === 'y') || (event.metaKey && event.shiftKey && event.key === 'Z'); // Cmd+Shift+Z for Redo on Mac

            if (isUndo) {
                event.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    markdownInput.value = history[historyIndex];
                    updatePreview();
                }
            } else if (isRedo) {
                event.preventDefault();
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    markdownInput.value = history[historyIndex];
                    updatePreview();
                }
            }
        });

        // Event listeners for drag and drop (images/links)
        markdownInput.addEventListener('dragover', function(event) {
            event.preventDefault(); // Necessary to allow drop
        });

        markdownInput.addEventListener('drop', function(event) {
            event.preventDefault(); // Prevent default file opening behavior

            const files = event.dataTransfer.files;
            const items = event.dataTransfer.items;

            // Basic check: prevent dropping local files directly for now
            if (files.length > 0) {
                alert('无法直接处理本地文件拖拽，请拖拽图片网址或文本。');
                return;
            }

            // Handle dropped items (links, potentially text)
            if (items.length > 0) {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    // Check if it's a URI or plain text
                    if (item.kind === 'string' && (item.type === 'text/uri-list' || item.type === 'text/plain')) {
                        item.getAsString(text => {
                            // Heuristic to check if it looks like an image URL
                            if (text.match(/\.(jpg|jpeg|png|gif|bmp|webp)(\?.*)?$/i)) {
                                const selectedText = markdownInput.value.substring(markdownInput.selectionStart, markdownInput.selectionEnd);
                                const altText = selectedText || '拖拽的图片'; // Use selected text or default
                                const markdownImage = `![${altText}](${text})`;
                                insertTextAtCursor(markdownImage);
                            } else if (text.startsWith('http://') || text.startsWith('https://')) {
                                // Assume it's a link if it starts with http/https but isn't an image
                                const markdownLink = `[链接文本](${text})`;
                                insertTextAtCursor(markdownLink);
                            } else {
                                // Otherwise, insert as plain text
                                insertTextAtCursor(text);
                            }
                            // Manually trigger input event to update history and preview
                            markdownInput.dispatchEvent(new Event('input'));
                        });
                        return; // Handle only the first valid string item
                    }
                }
            }
        });

        // *** MODIFIED PASTE EVENT LISTENER ***
        markdownInput.addEventListener('paste', function(event) {
            const clipboardData = event.clipboardData || window.clipboardData;
            if (!clipboardData) return; // Exit if no clipboard data

            const items = clipboardData.items;
            let handled = false; // Flag to track if the paste was handled

            // Check clipboard items
            for (let i = 0; i < items.length; i++) {
                // --- IMAGE HANDLING ---
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault(); // Prevent the default paste action
                    handled = true;

                    // Prompt the user for the image URL
                    const imageUrl = prompt("检测到粘贴的图片，请输入该图片的网址 (URL):", "http://");

                    // Check if the user entered a URL (didn't cancel and didn't leave it empty/default)
                    if (imageUrl && imageUrl.trim() !== "" && imageUrl.trim().toLowerCase() !== "http://") {
                        const altText = "粘贴的图片"; // You could prompt for Alt text too if needed
                        const markdownImage = `![${altText}](${imageUrl.trim()})`;
                        insertTextAtCursor(markdownImage);
                        // Manually trigger input event to update history and preview
                        markdownInput.dispatchEvent(new Event('input'));
                    } else {
                        // Optional: Provide feedback if the user cancelled or entered nothing useful
                        console.log("图片粘贴操作已取消或未提供有效网址。");
                         // Maybe insert a placeholder or do nothing
                    }
                    break; // Handle only the first image found
                }
            }

            // --- TEXT HANDLING ---
            // If not handled as an image, try handling as text
            if (!handled) {
                // Check specifically for 'text/plain'
                const text = clipboardData.getData('text/plain');
                if (text) {
                    event.preventDefault(); // Prevent the default text paste action
                    handled = true; // Mark as handled
                    insertTextAtCursor(text);
                    // Manually trigger input event to update history and preview
                    markdownInput.dispatchEvent(new Event('input'));
                }
            }

            // If handled is still false here, the browser might perform its default action
            // for any unhandled paste types.
        });

        // Event listener for the download button
        downloadButton.addEventListener('click', function() {
            const markdownContent = markdownInput.value;
            const filename = 'MyMarkdown.md'; // Default filename
            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' }); // Specify charset

            // Use File System Access API if available (more modern)
            if (window.showSaveFilePicker) {
                const options = {
                    suggestedName: filename,
                    types: [{
                        description: 'Markdown 文件',
                        accept: { 'text/markdown': ['.md'] },
                    }],
                };
                window.showSaveFilePicker(options).then(async (fileHandle) => {
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                }).catch(err => {
                    // Handle errors, e.g., user cancellation
                    if (err.name !== 'AbortError') {
                        console.error('无法保存文件:', err);
                        alert('保存文件失败。');
                    }
                });
            } else {
                // Fallback for older browsers using download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a); // Append link to body
                a.click(); // Programmatically click the link
                document.body.removeChild(a); // Remove link from body
                URL.revokeObjectURL(url); // Release the object URL
            }
        });

        // Initial setup: push initial state to history and render preview
        history.push(markdownInput.value);
        historyIndex = 0;
        updatePreview();

    </script>
</body>
</html>
